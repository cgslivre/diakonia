var app = angular.module('musicaEventosRecord', ['ngMessages','ngSanitize','remoteValidation'])
  .config(['$interpolateProvider', function ($interpolateProvider) {
      $interpolateProvider.startSymbol('<%');
      $interpolateProvider.endSymbol('%>');
}]);

var dateFormat = function() {
    return {
        // limit usage to argument only
        restrict: 'A',
        require: "ngModel",

        link: function(scope, element, attr, ctrl) {
            // please note you can name your function & argument anything you like
            function customValidator(ngModelValue) {

                var valid = moment(ngModelValue,'D/M/YYYY H:mm', true);
                console.log(ngModelValue + ": " +valid.isValid());
                if (valid.isValid()) {
                    ctrl.$setValidity('formato', true);
                } else {
                    ctrl.$setValidity('formato', false);
                }

                return ngModelValue;
            }

            ctrl.$parsers.push(customValidator);
        }
    };
};

app.directive("dateFormat", dateFormat);

app.controller('musicaEventoEditCtrl', ['$scope', '$http', '$location',
  function ($scope, $http,$location) {
    $scope.evento = {};
    $scope.evento.titulo = post['titulo'];
    $scope.evento.id = post['id'];
    var h = moment(post['hora']).format('D/M/YYYY H:mm');
    $scope.evento.hora = h;
  }
]);


app.controller('musicaEscalaCreateCtrl', ['$scope', '$http', '$location',
  function ($scope, $http,$location) {
    $scope.evento = {};
    $scope.evento.titulo = "Encontro Geral";
  }
]);

var app = angular.module('musicaEscalaRecord', ['ngMessages','ngSanitize','remoteValidation','ui.select'])
  .config(['$interpolateProvider', function ($interpolateProvider) {
      $interpolateProvider.startSymbol('<%');
      $interpolateProvider.endSymbol('%>')


}]);

app.directive("toggleClass", function() {
  return {
    link: function($scope, element, attr) {
      element.on("click", function() {
        element.toggleClass("option-selected");
      });
    }
  }
});

app.controller('musicaEscalaCreateCtrl', ['$scope', '$http', '$location', '$timeout',
  function ($scope, $http,$location,$timeout) {
    $scope.servicos = {};
    $scope.staffPorServico = [];
    $scope.staffSelecionado = {};

    var chamadaServicos = $http.get("/musica/servicos");


    chamadaServicos.then( function (response){
        $scope.servicos = response.data;

        for( i=0 ; i < $scope.servicos.length ; i++ ){
            $scope.servicos[i]['staffDisponivel'] = [];
            //$scope.staffSelecionado[i]['staffSelecionado'] = [];
        }
    }).then( function(){
        for( i=0 ; i < $scope.servicos.length ; i++ ){
           (function( id ){
               var url = "/musica/servicos/" + id + "/staff";
               console.log(url);
               $timeout(function () {
                   $http.get(url).then( function(response){
                       $scope.staffPorServico[id] = response.data;
                       $scope.staffSelecionado[id] = [];
                   });
               }, Math.floor(Math.random() * (800)) + 200);

           })($scope.servicos[i]['id']);

        }
    });



    $scope.serviceIcon = function( url ){
        //console.log(url);
        return window.location.origin + '/' + url;
	};

    $scope.avatar = function( url ){
        if( !url ){
            return window.location.origin + '/users/avatar/000-default-70px.jpg';
        } else{
            return window.location.origin + '/' + url + '70px.jpg';
        }
    }

    $scope.selectStaff = function( service, staff ){
        if( !service || !staff ) return;

        var idx  = $scope.staffSelecionado[service].indexOf( staff );
        if( idx  < 0 ){
            $scope.staffSelecionado[service].push( staff );

        } else{
            $scope.staffSelecionado[service].splice( idx, 1);
        }
    }


  }
]);
